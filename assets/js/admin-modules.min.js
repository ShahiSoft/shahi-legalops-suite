/**
 * ShahiLegalopsSuite - Premium Modules Page JavaScript V2
 * 
 * Enhanced functionality with search, filtering, animated statistics,
 * and smooth transitions for the redesigned modules page.
 *
 * @package    ShahiLegalopsSuite
 * @version    3.0.1
 */

(function($) {
    'use strict';

    /**
     * Modules Manager Object
     */
    const ShahiModules = {
        
        /**
         * Initialize the modules page functionality
         */
        init: function() {
            this.bindEvents();
            this.initSearch();
            this.initFilters();
            this.initStatCounters();
            this.initCardAnimations();
        },
        
        /**
         * Bind event handlers
         */
        bindEvents: function() {
            // Individual module toggle (both old and new class names)
            $('.shahi-module-toggle, .shahi-module-toggle-v2').on('change', this.handleModuleToggle.bind(this));
            
            // Enable all modules (both old and new IDs)
            $('#shahi-enable-all-modules, #shahi-enable-all-modules-v2').on('click', this.enableAllModules.bind(this));
            
            // Disable all modules (both old and new IDs)
            $('#shahi-disable-all-modules, #shahi-disable-all-modules-v2').on('click', this.disableAllModules.bind(this));
        },
        
        /**
         * Initialize search functionality
         */
        initSearch: function() {
            const $searchInput = $('#shahi-modules-search');
            const $clearBtn = $('.shahi-search-clear');
            const self = this;
            
            if (!$searchInput.length) return;
            
            // Search input handler with debounce
            let searchTimeout;
            $searchInput.on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().toLowerCase();
                
                // Show/hide clear button
                if (query) {
                    $clearBtn.fadeIn(200);
                } else {
                    $clearBtn.fadeOut(200);
                }
                
                searchTimeout = setTimeout(() => {
                    self.filterModules(query);
                }, 300);
            });
            
            // Clear button handler
            $clearBtn.on('click', function() {
                $searchInput.val('').focus();
                $clearBtn.fadeOut(200);
                self.filterModules('');
            });
        },
        
        /**
         * Initialize filter tabs
         */
        initFilters: function() {
            const self = this;
            
            $('.shahi-filter-tab').on('click', function() {
                const $tab = $(this);
                const filter = $tab.data('filter');
                
                // Update active state
                $('.shahi-filter-tab').removeClass('active');
                $tab.addClass('active');
                
                // Apply filter
                self.filterModulesByStatus(filter);
            });
        },
        
        /**
         * Initialize animated statistics counters
         */
        initStatCounters: function() {
            $('.shahi-stat-value-v2').each(function() {
                const $counter = $(this);
                const targetValue = parseInt($counter.data('count')) || 0;
                
                $counter.text('0');
                
                $({ value: 0 }).animate({ value: targetValue }, {
                    duration: 1500,
                    easing: 'easeOutCubic',
                    step: function() {
                        $counter.text(Math.ceil(this.value));
                    },
                    complete: function() {
                        $counter.text(targetValue);
                    }
                });
            });
        },
        
        /**
         * Initialize card entrance animations
         */
        initCardAnimations: function() {
            // Already handled by CSS, but can add intersection observer for scroll animations
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, {
                    threshold: 0.1
                });
                
                $('.shahi-module-card-v2').each(function() {
                    observer.observe(this);
                });
            }
        },
        
        /**
         * Filter modules by search query
         */
        filterModules: function(query) {
            const $cards = $('.shahi-module-card-v2');
            const $emptyState = $('#shahi-modules-empty');
            let visibleCount = 0;
            
            $cards.each(function() {
                const $card = $(this);
                const moduleName = $card.data('module-name') || '';
                const moduleKey = $card.data('module-key') || '';
                const moduleCategory = $card.data('module-category') || '';
                
                const searchText = `${moduleName} ${moduleKey} ${moduleCategory}`.toLowerCase();
                const matches = !query || searchText.includes(query);
                
                if (matches) {
                    $card.fadeIn(300);
                    visibleCount++;
                } else {
                    $card.fadeOut(300);
                }
            });
            
            // Show/hide empty state
            if (visibleCount === 0) {
                $emptyState.fadeIn(300);
            } else {
                $emptyState.fadeOut(300);
            }
        },
        
        /**
         * Filter modules by status
         */
        filterModulesByStatus: function(status) {
            const $cards = $('.shahi-module-card-v2');
            const $emptyState = $('#shahi-modules-empty');
            let visibleCount = 0;
            
            $cards.each(function() {
                const $card = $(this);
                const moduleStatus = $card.data('module-status');
                
                let shouldShow = false;
                if (status === 'all') {
                    shouldShow = true;
                } else if (status === 'active' && moduleStatus === 'active') {
                    shouldShow = true;
                } else if (status === 'inactive' && moduleStatus === 'inactive') {
                    shouldShow = true;
                }
                
                if (shouldShow) {
                    $card.fadeIn(300);
                    visibleCount++;
                } else {
                    $card.fadeOut(300);
                }
            });
            
            // Show/hide empty state
            if (visibleCount === 0) {
                $emptyState.fadeIn(300);
            } else {
                $emptyState.fadeOut(300);
            }
        },
        
        /**
         * Handle individual module toggle
         */
        handleModuleToggle: function(e) {
            const $checkbox = $(e.currentTarget);
            const $card = $checkbox.closest('.shahi-module-card, .shahi-module-card-v2');
            const moduleKey = $checkbox.data('module-key');
            const enabled = $checkbox.is(':checked');
            
            // Add loading state
            $card.addClass('shahi-module-loading module-loading');
            
            // Send AJAX request
            $.ajax({
                url: shahiModulesData.ajaxUrl,
                type: 'POST',
                data: {
                    action: 'shahi_toggle_module',
                    nonce: shahiModulesData.toggleNonce,
                    module_key: moduleKey,
                    enabled: enabled
                },
                success: (response) => {
                    this.handleToggleSuccess(response, $card, $checkbox, enabled);
                },
                error: (xhr, status, error) => {
                    this.handleToggleError(error, $card, $checkbox, enabled);
                },
                complete: () => {
                    $card.removeClass('shahi-module-loading module-loading');
                }
            });
        },
        
        /**
         * Handle successful module toggle
         */
        handleToggleSuccess: function(response, $card, $checkbox, enabled) {
            if (response.success) {
                // Update card visual state
                if (enabled) {
                    $card.addClass('shahi-module-active module-enabled')
                         .removeClass('module-disabled')
                         .attr('data-module-status', 'active');
                         
                    // Update status badge
                    $card.find('.shahi-module-status-badge')
                         .removeClass('status-inactive')
                         .addClass('status-active')
                         .find('.status-text').text('Active');
                } else {
                    $card.removeClass('shahi-module-active module-enabled')
                         .addClass('module-disabled')
                         .attr('data-module-status', 'inactive');
                         
                    // Update status badge
                    $card.find('.shahi-module-status-badge')
                         .removeClass('status-active')
                         .addClass('status-inactive')
                         .find('.status-text').text('Inactive');
                }
                
                // Update statistics
                this.updateStatistics(enabled);
                
                // Update filter tab counts
                this.updateFilterCounts();
                
                // Show success notification
                this.showNotification(
                    enabled ? shahiModulesData.i18n.enabled : shahiModulesData.i18n.disabled,
                    'success'
                );
                
                // Add success animation
                this.animateCardSuccess($card);
            } else {
                // Revert checkbox state
                $checkbox.prop('checked', !enabled);
                
                // Show error notification
                this.showNotification(response.data.message || shahiModulesData.i18n.error, 'error');
            }
        },
        
        /**
         * Handle module toggle error
         */
        handleToggleError: function(error, $card, $checkbox, enabled) {
            // Revert checkbox state
            $checkbox.prop('checked', !enabled);
            
            // Show error notification
            this.showNotification(shahiModulesData.i18n.error, 'error');
            
            console.error('Module toggle error:', error);
        },
        
        /**
         * Enable all modules
         */
        enableAllModules: function(e) {
            e.preventDefault();
            
            if (!confirm(shahiModulesData.i18n.confirmEnableAll || 'Are you sure you want to enable all modules?')) {
                return;
            }
            
            const $modules = $('.shahi-module-toggle:not(:checked), .shahi-module-toggle-v2:not(:checked)');
            
            if ($modules.length === 0) {
                this.showNotification('All modules are already enabled.', 'info');
                return;
            }
            
            // Show bulk operation notification
            this.showNotification(`Enabling ${$modules.length} modules...`, 'info');
            
            // Enable each module
            $modules.each((index, element) => {
                setTimeout(() => {
                    $(element).prop('checked', true).trigger('change');
                }, index * 200); // Stagger the requests
            });
        },
        
        /**
         * Disable all modules
         */
        disableAllModules: function(e) {
            e.preventDefault();
            
            if (!confirm(shahiModulesData.i18n.confirmDisableAll || 'Are you sure you want to disable all modules? Some features may become unavailable.')) {
                return;
            }
            
            const $modules = $('.shahi-module-toggle:checked, .shahi-module-toggle-v2:checked');
            
            if ($modules.length === 0) {
                this.showNotification('All modules are already disabled.', 'info');
                return;
            }
            
            // Show bulk operation notification
            this.showNotification(`Disabling ${$modules.length} modules...`, 'info');
            
            // Disable each module
            $modules.each((index, element) => {
                setTimeout(() => {
                    $(element).prop('checked', false).trigger('change');
                }, index * 200); // Stagger the requests
            });
        },
        
        /**
         * Update statistics counters
         */
        updateStatistics: function(enabled) {
            // Try both old and new selectors
            const $stats = $('.shahi-modules-stats-v2, .shahi-modules-stats');
            const $activeValue = $stats.find('.shahi-stat-value-v2[data-count], .shahi-stat-value').eq(1);
            const $inactiveValue = $stats.find('.shahi-stat-value-v2[data-count], .shahi-stat-value').eq(2);
            
            if ($activeValue.length && $inactiveValue.length) {
                let active = parseInt($activeValue.text());
                let inactive = parseInt($inactiveValue.text());
                
                if (enabled) {
                    active++;
                    inactive--;
                } else {
                    active--;
                    inactive++;
                }
                
                // Animate the change
                this.animateValue($activeValue, active);
                this.animateValue($inactiveValue, inactive);
            }
        },
        
        /**
         * Update filter tab counts
         */
        updateFilterCounts: function() {
            const totalCount = $('.shahi-module-card-v2, .shahi-module-card').length;
            const activeCount = $('.shahi-module-card-v2.module-enabled, .shahi-module-card.shahi-module-active').length;
            const inactiveCount = totalCount - activeCount;
            
            // Update filter tab counts
            $('.shahi-filter-tab[data-filter="all"] .shahi-tab-count').text(totalCount);
            $('.shahi-filter-tab[data-filter="active"] .shahi-tab-count').text(activeCount);
            $('.shahi-filter-tab[data-filter="inactive"] .shahi-tab-count').text(inactiveCount);
        },
        
        /**
         * Animate number value change
         */
        animateValue: function($element, newValue) {
            const currentValue = parseInt($element.text()) || 0;
            
            $({ value: currentValue }).animate({ value: newValue }, {
                duration: 500,
                easing: 'swing',
                step: function() {
                    $element.text(Math.ceil(this.value));
                },
                complete: function() {
                    $element.text(newValue);
                }
            });
        },
        
        /**
         * Show notification message
         */
        showNotification: function(message, type = 'success') {
            // Use ShahiNotify if available
            if (typeof ShahiNotify !== 'undefined') {
                ShahiNotify.show(message, type);
                return;
            }
            
            // Fallback to WordPress admin notices
            const noticeClass = type === 'success' ? 'notice-success' : 
                               type === 'error' ? 'notice-error' : 
                               'notice-info';
            
            const $notice = $('<div>', {
                class: `notice ${noticeClass} is-dismissible shahi-admin-notice`,
                html: `<p>${message}</p>`
            }).hide();
            
            $('.shahi-modules-page-v2, .shahi-modules-page').prepend($notice);
            $notice.slideDown(300);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $notice.slideUp(300, () => $notice.remove());
            }, 5000);
        },
        
        /**
         * Animate card success
         */
        animateCardSuccess: function($card) {
            // Add pulse animation
            $card.css({
                transform: 'scale(1.03)',
                transition: 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)'
            });
            
            setTimeout(() => {
                $card.css({
                    transform: 'scale(1)'
                });
            }, 200);
        }
    };
    
    /**
     * Initialize on document ready
     */
    $(document).ready(function() {
        // Check if we're on the modules page (both versions)
        if ($('.shahi-modules-page-v2, .shahi-modules-page').length) {
            ShahiModules.init();
        }
    });
    
    /**
     * Expose to global scope for potential extensions
     */
    window.ShahiModules = ShahiModules;

})(jQuery);

